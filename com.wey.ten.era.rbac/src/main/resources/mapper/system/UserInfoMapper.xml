<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wey.ten.era.rbac.system.dao.UserInfoDao">
    <resultMap type="UserInfo" id="BaseResultMap">
        <id  column="user_id"  property="userId" jdbcType="INTEGER"/>
        <result column="account_number"  property="accountNumber" jdbcType="VARCHAR"/>
        <result column="password"  property="password" jdbcType="VARCHAR"/>
        <result column="user_status"  property="userStatus" jdbcType="INTEGER"/>
        <result column="user_name"  property="userName" jdbcType="VARCHAR"/>
        <result column="phone_number"  property="phoneNumber" jdbcType="BIGINT"/>
        <result column="email"  property="email" jdbcType="VARCHAR"/>
        <result column="create_time"  property="createTime" />
        <result column="update_time"  property="updateTime" />
        <result column="is_parent"  property="isParent" jdbcType="INTEGER"/>
        <result column="affiliated_company"  property="affiliatedCompany" jdbcType="INTEGER"/>
    </resultMap>

    <sql id="where">
        <where>
            <if test="accountNumber != null and accountNumber != ''">
                and u.account_number = #{accountNumber}
            </if>
            <if test="password != null and password != ''">
                and u.password = #{password}
            </if>
            <if test="email != null and email != ''">
                and u.email = #{email}
            </if>
            <if test="phoneNumber != null and phoneNumber != ''">
                and u.phone_number = #{phoneNumber}
            </if>
        </where>
    </sql>

    <sql id="baseColumn">
    ui.user_id,
    ui.account_number,
    ui.password,
    ui.user_status,
    ui.user_name,
    ui.phone_number,
    ui.email,
    ui.create_time,
    ui.update_time,
    ui.affiliated_company,
    ui.is_parent
  </sql>

    <select id="detailUserInfo" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        SELECT
        <include refid="baseColumn"></include>
        FROM user_info ui
        WHERE ui.user_id=#{userId}
    </select>

    <select id="getPasswordByAccount" resultMap="BaseResultMap" parameterType="java.lang.String">
        SELECT *
        FROM user_info
        where
        <if test="type!=null and type == 1">
            phone_number=#{account}
        </if>
        <if test="type!=null and type == 2">
            email=#{account}
        </if>
    </select>
    <!--    <select id="queryUserInfo" resultMap="BaseResultMap" parameterType="UserInfo">
            SELECT
            <include refid="baseColumn"></include>
            FROM user_info ui join enterprise_info ei on ui.user_id = ei.user_id
            WHERE user_status=1
            <if test="accountNumber!=null">
                and account_number like CONCAT('%',#{accountNumber},'%')
            </if>
            <if test="userName!=null">
                and user_name=#{userName}
            </if>
            <if test="phoneNumber!=null">
                and phone_number=#{phoneNumber}
            </if>
            <if test="email!=null">
                and email=#{email}
            </if>
    &lt;!&ndash;        <if test="corporateName!=null">
                corporate_name=#{corporateName}
            </if>&ndash;&gt;
            order by create_time
            limit #{startRow},#{endRow}
        </select>

        <select id="getCount" resultType="java.lang.Integer" parameterType="UserInfo">
            SELECT count(*)
            FROM user_info ui join enterprise_info ei on ui.user_id = ei.user_id
            WHERE 1=1
            <if test="accountNumber!=null">
                and account_number like CONCAT('%',#{accountNumber},'%')
            </if>
            <if test="userName!=null">
                and user_name=#{userName}
            </if>
            <if test="phoneNumber!=null">
                and phone_number=#{phoneNumber}
            </if>
            <if test="email!=null">
                and email=#{email}
            </if>
    &lt;!&ndash;        <if test="corporate_name!=null">
                corporate_name=#{phoneNumber}
            </if>&ndash;&gt;
        </select>-->

    <select id="findList" resultMap="BaseResultMap">
        select * from user_info u
        <where>
            <if test="e.accountNumber!=null">
                and u.account_number like CONCAT('%',#{e.accountNumber},'%')
            </if>
            <if test="e.userName!=null">
                and u.user_name=#{e.userName}
            </if>
            <if test="e.phoneNumber!=null">
                and u.phone_number=#{e.phoneNumber}
            </if>
            <if test="e.email!=null">
                and u.email=#{e.email}
            </if>
            <if test="e.password != null">
                and u.password = #{e.password}
            </if>
        </where>
        order by u.create_time desc
    </select>

    <insert id="saveUserInfo" parameterType="UserInfo">
  	 insert into user_info
  	 (
  	    account_number,
        password,
        user_status,
        user_name,
        phone_number,
        email,
        create_time,
        update_time
  	 )values(
  	    #{phoneNumber},
  	    #{password},
  	    1,
  	    #{userName},
  	    #{phoneNumber},
  	    #{email},
  	    NOW(),
  	    NOW()
  	 )
  </insert>

    <delete id="delUserInfo" parameterType="java.lang.Integer">
  	    delete from user_info where user_id=#{0}
    </delete>

    <update id="updateUserInfo" parameterType="UserInfo">
    update user_info set
    <if test="accountNumber != null">account_number=#{phoneNumber},</if>
    <if test="password != null">password=#{password},</if>
    <if test="userStatus != null">user_status=#{userStatus},</if>
    <if test="userName != null">user_name=#{userName},</if>
    <if test="phoneNumber != null">phone_number=#{phoneNumber},</if>
    <if test="email != null">email=#{email},</if>
    update_time=NOW()
    where
    user_id=#{userId}
</update>

    <update id="modifyBinding" parameterType="map">
        update user_info set update_time=NOW(),
        <if test="type!=null and type == 1">
            phone_number=#{account}
        </if>
        <if test="type!=null and type == 2">
            email=#{account}
        </if>
        where
        user_id=#{userId}
    </update>

    <select id="verificationPhoneOnly" resultType="int"  parameterType="string">
        select count(*) from user_info where phone_number=#{phoneNumber}
    </select>

    <select id="verificationEmailOnly" resultType="int"  parameterType="string">
        select count(*) from user_info where email=#{0}
    </select>

    <select id="getUserByUserId" resultType="map"  parameterType="java.lang.Integer">
				select u.user_name as userName, e.enterpris_name as enterprisName, i.industry_type as industryName
                from user_info u
                LEFT JOIN enterprise_info e
                on u.user_id = e.user_id
                LEFT JOIN industry_info i
                on e.industry_id = i.industry_id
				where
				u.user_id=#{userId}
    </select>

    <update id="updateAffiliatedCompany" parameterType="map"> 
    	update user_info set affiliated_company = #{affiliatedCompany},is_parent =#{isParent} where user_id=#{userId}
    </update>
    <select id="getAll" resultMap="BaseResultMap">
    	select * from user_info
    </select>
    <update id="updatePassword" parameterType="UserInfo">
    	update user_info set password=#{password} where user_id=#{userId}
    </update>
    <update id="modifyPassword" parameterType="map">
        update user_info set password=#{password} where
        <if test="type!=null and type == 1">
            phone_number=#{account}
        </if>
        <if test="type!=null and type == 2">
            email=#{account}
        </if>
    </update>

    <!-- add by wujian -->
    <select id="getByEmail" resultMap="BaseResultMap">
    	select * from user_info where email = #{email} limit 1
    </select>

    <select id="getByMobile" resultMap="BaseResultMap">
    	select * from user_info where phone_number = #{mobile} limit 1
    </select>

    <select id="getByAccount" resultMap="BaseResultMap">
    	select * from user_info where account_number = #{account} limit 1
    </select>
</mapper>
